<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - EDTTI University Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7A0C0C',
                        secondary: '#8B2A2A',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex items-center justify-center p-4">
    <!-- Background Pattern -->
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.1"%3E%3Ccircle cx="30" cy="30" r="1"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-40"></div>
    
    <!-- Reset Password Container -->
    <div class="relative w-full max-w-md">
        <!-- Reset Password Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="mx-auto w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center mb-4">
                    <i class="ri-lock-password-line text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Reset Password</h1>
                <p class="text-gray-600" id="subtitle">Enter your new password</p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
                <p class="text-gray-600">Validating reset token...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center py-8">
                <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <i class="ri-error-warning-line text-red-600 text-2xl"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Invalid Reset Link</h2>
                <p class="text-gray-600 mb-6" id="error-message">This reset link is invalid or has expired.</p>
                <a href="/" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    <i class="ri-arrow-left-line mr-2"></i>
                    Back to Login
                </a>
            </div>

            <!-- Reset Form -->
            <form id="resetForm" class="space-y-6 hidden">
                <!-- User Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center mr-3">
                            <i class="ri-user-line text-white"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800" id="user-name">Loading...</p>
                            <p class="text-sm text-gray-600" id="user-identifier">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- New Password -->
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="ri-lock-line mr-2 text-primary"></i>New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword" 
                            placeholder="Enter your new password"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 pr-12"
                            required
                            minlength="6"
                        >
                        <button 
                            type="button" 
                            id="toggleNewPassword" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            onclick="togglePasswordVisibility('newPassword', 'newPasswordIcon')"
                        >
                            <i id="newPasswordIcon" class="ri-eye-line"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Password must be at least 6 characters long</p>
                </div>

                <!-- Confirm Password -->
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="ri-lock-line mr-2 text-primary"></i>Confirm New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            placeholder="Confirm your new password"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 pr-12"
                            required
                            minlength="6"
                        >
                        <button 
                            type="button" 
                            id="toggleConfirmPassword" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            onclick="togglePasswordVisibility('confirmPassword', 'confirmPasswordIcon')"
                        >
                            <i id="confirmPasswordIcon" class="ri-eye-line"></i>
                        </button>
                    </div>
                    <div id="password-match" class="text-sm mt-1 hidden"></div>
                </div>

                <!-- Password Strength Indicator -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-start">
                        <i class="ri-information-line text-blue-600 mr-2 mt-0.5"></i>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium mb-1">Password Requirements:</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>At least 6 characters long</li>
                                <li>Use a combination of letters and numbers</li>
                                <li>Avoid using personal information</li>
                                <li>Choose something unique and memorable</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Reset Button -->
                <button 
                    type="submit" 
                    id="resetBtn"
                    class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-6 rounded-xl font-medium hover:from-secondary hover:to-primary focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="ri-lock-unlock-line mr-2"></i>
                    <span id="resetBtnText">Reset Password</span>
                </button>
            </form>

            <!-- Success State -->
            <div id="success-state" class="hidden text-center py-8">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <i class="ri-check-line text-green-600 text-2xl"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Password Reset Successful!</h2>
                <p class="text-gray-600 mb-6">Your password has been updated successfully. You can now log in with your new password.</p>
                <a href="/" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    <i class="ri-login-box-line mr-2"></i>
                    Go to Login
                </a>
            </div>

            <!-- Links -->
            <div class="mt-8 text-center">
                <a href="/" class="text-primary hover:text-secondary transition-colors text-sm">
                    <i class="ri-arrow-left-line mr-1"></i>Back to Login
                </a>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-gray-600 text-sm">
            <p>&copy; 2025 EDTTI University Management System. All rights reserved.</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 transform translate-x-full transition-transform duration-300 z-50">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 min-w-[300px]">
            <div class="flex items-center">
                <div id="toastIcon" class="mr-3"></div>
                <div>
                    <p id="toastMessage" class="font-medium"></p>
                </div>
                <button onclick="hideToast()" class="ml-4 text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let resetToken = null;
        let userType = null;

        // DOM Elements
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-state');
        const resetForm = document.getElementById('resetForm');
        const successDiv = document.getElementById('success-state');

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeResetPage();
        });

        // Initialize reset page
        async function initializeResetPage() {
            try {
                // Get token and userType from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                resetToken = urlParams.get('token');
                userType = urlParams.get('type');

                if (!resetToken || !userType) {
                    showError('Invalid reset link. Missing required parameters.');
                    return;
                }

                // Validate token with backend
                const response = await fetch(`/api/auth/validate-reset-token/${resetToken}?userType=${userType}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    showError(data.message || 'Invalid or expired reset token.');
                    return;
                }

                // Show reset form with user info
                showResetForm(data.user);

            } catch (error) {
                console.error('Error initializing reset page:', error);
                showError('Failed to validate reset token. Please try again.');
            }
        }

        // Show error state
        function showError(message) {
            loadingDiv.classList.add('hidden');
            resetForm.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            document.getElementById('error-message').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Show reset form
        function showResetForm(user) {
            loadingDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Populate user info
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-identifier').textContent = user.identifier;
            
            resetForm.classList.remove('hidden');
            
            // Setup form validation
            setupFormValidation();
        }

        // Show success state
        function showSuccess() {
            loadingDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            resetForm.classList.add('hidden');
            
            successDiv.classList.remove('hidden');
        }

        // Setup form validation
        function setupFormValidation() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const matchDiv = document.getElementById('password-match');
            const resetBtn = document.getElementById('resetBtn');

            // Real-time password matching
            function checkPasswordMatch() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (confirmPassword.length > 0) {
                    if (newPassword === confirmPassword) {
                        matchDiv.textContent = '✓ Passwords match';
                        matchDiv.className = 'text-sm mt-1 text-green-600';
                        matchDiv.classList.remove('hidden');
                    } else {
                        matchDiv.textContent = '✗ Passwords do not match';
                        matchDiv.className = 'text-sm mt-1 text-red-600';
                        matchDiv.classList.remove('hidden');
                    }
                } else {
                    matchDiv.classList.add('hidden');
                }

                // Enable/disable submit button
                resetBtn.disabled = !(newPassword.length >= 6 && newPassword === confirmPassword);
            }

            newPasswordInput.addEventListener('input', checkPasswordMatch);
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);

            // Form submission
            resetForm.addEventListener('submit', handlePasswordReset);
        }

        // Handle password reset
        async function handlePasswordReset(e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetBtn = document.getElementById('resetBtn');
            const resetBtnText = document.getElementById('resetBtnText');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters long', 'error');
                return;
            }

            try {
                // Update button state
                resetBtn.disabled = true;
                resetBtnText.textContent = 'Resetting...';

                // Send reset request
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: resetToken,
                        newPassword: newPassword,
                        userType: userType
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess();
                    showToast('Password reset successfully!', 'success');
                } else {
                    showToast(data.message || 'Failed to reset password', 'error');
                }

            } catch (error) {
                console.error('Error resetting password:', error);
                showToast('Failed to reset password. Please try again.', 'error');
            } finally {
                // Reset button state
                resetBtn.disabled = false;
                resetBtnText.textContent = 'Reset Password';
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ri-eye-off-line';
            } else {
                input.type = 'password';
                icon.className = 'ri-eye-line';
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set icon and colors based on type
            const configs = {
                success: {
                    icon: 'ri-check-circle-line text-green-500',
                    borderColor: 'border-l-green-500'
                },
                error: {
                    icon: 'ri-error-warning-line text-red-500',
                    borderColor: 'border-l-red-500'
                },
                info: {
                    icon: 'ri-information-line text-blue-500',
                    borderColor: 'border-l-blue-500'
                }
            };
            
            const config = configs[type] || configs.info;
            
            toastIcon.className = config.icon;
            toast.querySelector('.bg-white').className = `bg-white rounded-lg shadow-lg border-l-4 ${config.borderColor} p-4 min-w-[300px]`;
            toastMessage.textContent = message;
            
            // Show toast
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
            
            // Auto hide after 5 seconds
            setTimeout(hideToast, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-full');
            toast.classList.remove('translate-x-0');
        }
    </script>
</body>
</html>




