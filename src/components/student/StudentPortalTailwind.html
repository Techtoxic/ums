<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDTTI Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Frontend Config (Load First!) -->
    <script src="/public/js/config.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7A0C0C',
                        secondary: '#8B2A2A',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-gentle': 'bounceGentle 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #7A0C0C 0%, #8B2A2A 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
.js
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .progress-ring {
            transition: stroke-dasharray 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .sidebar-collapsed {
            width: 4rem !important;
        }

        .sidebar-collapsed .sidebar-text {
            display: none !important;
        }

        .sidebar-collapsed .sidebar-title {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans">
    <!-- Mobile Menu Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white dark:bg-gray-800 shadow-xl z-50 transition-all duration-300 flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                    <i class="ri-graduation-cap-line text-white text-lg"></i>
                </div>
                <div class="sidebar-title">
                    <h1 class="text-lg font-bold text-gray-800 dark:text-white">EDTTI Portal</h1>
                </div>
            </div>
            <button id="sidebar-toggle" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg md:hidden">
                <i class="ri-close-line text-xl text-gray-600 dark:text-gray-300"></i>
            </button>
        </div>

        <!-- User Profile -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                    <i class="ri-user-line text-white text-lg"></i>
                </div>
                <div class="sidebar-text flex-1 min-w-0">
                    <p class="text-sm font-semibold text-gray-800 dark:text-white truncate student-name">Loading...</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate student-admission">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 overflow-y-auto">
            <ul class="space-y-2">
                <li>
                    <a href="#dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors active">
                        <i class="ri-dashboard-3-line text-lg"></i>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#profile" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-user-3-line text-lg"></i>
                        <span class="sidebar-text">Profile</span>
                    </a>
                </li>
                <li>
                    <a href="#financial" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-money-dollar-circle-line text-lg"></i>
                        <span class="sidebar-text">Financial Info</span>
                    </a>
                </li>
                <li>
                    <a href="#payments" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-receipt-line text-lg"></i>
                        <span class="sidebar-text">Payment History</span>
                    </a>
                </li>
                <li>
                    <a href="#uploads" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-upload-cloud-line text-lg"></i>
                        <span class="sidebar-text">Uploads</span>
                    </a>
                </li>
                <li>
                    <a href="#notes" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-message-3-line text-lg"></i>
                        <span class="sidebar-text">Notes & Messages</span>
                        <span id="notes-badge" class="hidden ml-auto px-2 py-0.5 text-xs font-semibold text-white bg-red-500 rounded-full">0</span>
                    </a>
                </li>
                <li>
                    <a href="#units" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-book-open-line text-lg"></i>
                        <span class="sidebar-text">Units & Courses</span>
                    </a>
                </li>
                <li>
                    <a href="#transcript" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-file-text-line text-lg"></i>
                        <span class="sidebar-text">Transcript</span>
                    </a>
                </li>
                <li>
                    <a href="#graduation" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-graduation-cap-line text-lg"></i>
                        <span class="sidebar-text">Apply for Graduation</span>
                    </a>
                </li>
                <li>
                    <a href="#attachment" class="nav-link flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="ri-briefcase-line text-lg"></i>
                        <span class="sidebar-text">Apply for Attachment</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
            <div class="space-y-2">
                <button id="dark-mode-toggle" class="w-full flex items-center gap-3 px-3 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="ri-moon-line text-lg dark:ri-sun-line"></i>
                    <span class="sidebar-text">Dark Mode</span>
                </button>
                <button id="logout-btn" class="w-full flex items-center gap-3 px-3 py-2.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                    <i class="ri-logout-box-line text-lg"></i>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="md:ml-64 transition-all duration-300">
        <!-- Top Bar -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
            <div class="flex items-center justify-between px-2 py-1.5 text-xs">
                <div class="flex items-center gap-2">
                    <button id="mobile-menu-btn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg md:hidden">
                        <i class="ri-menu-line text-xl text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <button id="desktop-sidebar-toggle" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg hidden md:block">
                        <i class="ri-menu-fold-line text-xl text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <h2 id="page-title" class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Dashboard</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                        <i class="ri-time-line"></i>
                        <span id="current-time">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-2 md:p-4 space-y-3">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section">
                <!-- Welcome Card -->
                <div class="bg-gradient-to-r from-primary to-secondary rounded-lg p-3 md:p-4 text-white mb-3 card-hover">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
                        <div>
                            <h1 class="text-base md:text-lg font-bold mb-1">Welcome, <span class="student-name">Student</span>!</h1>
                            <p class="text-white/80 text-xs md:text-sm">Hope you're having a great day learning.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-center">
                                <div class="text-lg md:text-xl font-bold student-year">-</div>
                                <div class="text-xs text-white/70">Year</div>
                            </div>
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="ri-graduation-cap-line text-xl md:text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                    <!-- Program Cost Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-2 md:p-3 shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                                <i class="ri-price-tag-3-line text-blue-600 text-sm md:text-base"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded-full">Program</span>
                        </div>
                        <div>
                            <p class="text-base md:text-lg font-bold text-gray-800 dark:text-white program-cost">Loading...</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Total Program Cost</p>
                        </div>
                    </div>

                    <!-- Total Paid Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-2 md:p-3 shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-8 h-8 md:w-10 md:h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                                <i class="ri-check-double-line text-green-600 text-sm md:text-base"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded-full">Paid</span>
                        </div>
                        <div>
                            <p class="text-base md:text-lg font-bold text-green-600 total-paid">KES 0</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Total Paid</p>
                        </div>
                    </div>

                    <!-- Balance Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-2 md:p-3 shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-8 h-8 md:w-10 md:h-10 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center">
                                <i class="ri-wallet-3-line text-orange-600 text-sm md:text-base"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded-full">Balance</span>
                        </div>
                        <div>
                            <p class="text-base md:text-lg font-bold text-orange-600 balance">KES 0</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Outstanding Balance</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Progress -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-2 md:p-3 shadow-sm border border-gray-200 dark:border-gray-700 mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Payment Progress</h3>
                        <span id="payment-percentage" class="text-xs font-medium text-gray-600 dark:text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-1">
                        <div id="payment-progress" class="bg-gradient-to-r from-primary to-secondary h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                        <span>KES 0</span>
                        <span class="program-cost-text">KES 0</span>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-2 md:p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white mb-2">Recent Activity</h3>
                    <div id="recent-activity" class="space-y-2">
                        <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                                <i class="ri-user-line text-blue-600 text-xs md:text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs md:text-sm font-medium text-gray-800 dark:text-white">Profile updated</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Welcome to the portal</p>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">Just now</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-2 md:p-3 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Student Profile</h2>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">Your academic information and details</p>
                    </div>
                    <div class="p-2 md:p-3">
                        <div class="grid md:grid-cols-2 gap-3">
                            <!-- Profile Info -->
                            <div class="space-y-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                                        <i class="ri-user-line text-white text-lg md:text-2xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white student-name">Loading...</h3>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 student-admission">Loading...</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 gap-2">
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">ID Number</label>
                                        <p class="text-xs md:text-sm text-gray-800 dark:text-white font-medium student-id">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Phone Number</label>
                                        <p class="text-xs md:text-sm text-gray-800 dark:text-white font-medium student-phone">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Email Address</label>
                                        <div class="flex items-center justify-between">
                                            <p class="text-xs md:text-sm text-gray-800 dark:text-white font-medium student-email">Not set</p>
                                            <button onclick="openEmailUpdateModal()" class="text-primary hover:text-secondary text-xs font-medium">
                                                <i class="ri-edit-line mr-1"></i>Update
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">KCSE Grade</label>
                                        <p class="text-xs md:text-sm text-gray-800 dark:text-white font-medium student-kcse">Loading...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Academic Info -->
                            <div class="space-y-2">
                                <h4 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Academic Information</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Course</label>
                                        <p class="text-gray-800 dark:text-white font-medium student-course-name">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Department</label>
                                        <p class="text-gray-800 dark:text-white font-medium student-department">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Year of Study</label>
                                        <p class="text-gray-800 dark:text-white font-medium student-year-text">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Intake</label>
                                        <p class="text-gray-800 dark:text-white font-medium student-intake-combined">Loading...</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Admission Type</label>
                                        <p class="text-gray-800 dark:text-white font-medium student-admission-type">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financial Section -->
            <section id="financial" class="content-section hidden">
                <div class="space-y-2">
                    <!-- Financial Overview -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Financial Information</h2>
                            <p class="text-gray-600 dark:text-gray-400 mt-1">Your payment status and program costs</p>
                        </div>
                        <div class="p-6">
                            <div class="grid md:grid-cols-3 gap-2 mb-3">
                                <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="ri-price-tag-3-line text-white text-xl"></i>
                                    </div>
                                    <p class="text-2xl font-bold text-blue-600 program-cost">KES 0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Program Cost</p>
                                </div>
                                <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
                                    <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="ri-check-double-line text-white text-xl"></i>
                                    </div>
                                    <p class="text-2xl font-bold text-green-600 total-paid">KES 0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Total Paid</p>
                                </div>
                                <div class="text-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl">
                                    <div class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="ri-wallet-3-line text-white text-xl"></i>
                                    </div>
                                    <p class="text-2xl font-bold text-orange-600 balance">KES 0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Balance</p>
                                </div>
                            </div>

                            <!-- Payment Progress Chart -->
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2 md:p-3">
                                <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white mb-4">Payment Progress</h3>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-gray-600 dark:text-gray-400">Progress</span>
                                            <span id="financial-payment-percentage" class="text-sm font-medium text-gray-800 dark:text-white">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4">
                                            <div id="financial-payment-progress" class="bg-gradient-to-r from-primary to-secondary h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="w-16 h-16 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center shadow-sm">
                                        <span id="financial-progress-icon" class="text-2xl">ðŸ“Š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Program Details -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Program Details</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Program Name:</span>
                                        <span class="font-medium text-gray-800 dark:text-white student-course-name">Loading...</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Department:</span>
                                        <span class="font-medium text-gray-800 dark:text-white student-department">Loading...</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Year of Study:</span>
                                        <span class="font-medium text-gray-800 dark:text-white student-year-text">Loading...</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Program Cost:</span>
                                        <span class="font-medium text-primary program-cost">Loading...</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Amount Paid:</span>
                                        <span class="font-medium text-green-600 total-paid">KES 0</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                        <span class="text-gray-600 dark:text-gray-400">Outstanding:</span>
                                        <span class="font-medium text-orange-600 balance">KES 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payment History Section -->
            <section id="payments" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Payment History</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Track all your payments and transactions</p>
                    </div>
                    <div class="p-6">
                        <div id="payment-history" class="space-y-2">
                            <div class="text-center py-8">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="ri-receipt-line text-2xl text-gray-400"></i>
                                </div>
                                <p class="text-gray-600 dark:text-gray-400">No payment history available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payment Receipt Modal -->
            <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Payment Receipt</h3>
                            <button id="close-receipt-modal" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                <i class="ri-close-line text-xl text-gray-600 dark:text-gray-300"></i>
                            </button>
                        </div>
                    </div>
                    <div id="receipt-content" class="p-6">
                        <!-- Receipt content will be populated here -->
                    </div>
                    <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex gap-3">
                        <button id="export-receipt" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors flex items-center justify-center gap-2">
                            <i class="ri-download-line"></i>
                            Export Receipt
                        </button>
                        <button id="print-receipt" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                            <i class="ri-printer-line"></i>
                            Print
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Update Modal -->
            <div id="email-update-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Update Email Address</h3>
                            <button onclick="closeEmailUpdateModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                <i class="ri-close-line text-xl text-gray-600 dark:text-gray-300"></i>
                            </button>
                        </div>
                    </div>
                    <form id="email-update-form" class="p-6">
                        <div class="space-y-2">
                            <div>
                                <label for="new-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="ri-mail-line mr-2 text-primary"></i>New Email Address
                                </label>
                                <input 
                                    type="email" 
                                    id="new-email" 
                                    placeholder="Enter your new email address"
                                    class="w-full px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    required
                                >
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                                <div class="flex items-start">
                                    <i class="ri-information-line text-blue-600 dark:text-blue-400 mr-2 mt-0.5"></i>
                                    <div class="text-sm text-blue-700 dark:text-blue-300">
                                        <p class="font-medium mb-1">Important Notes:</p>
                                        <ul class="list-disc list-inside space-y-1 text-xs">
                                            <li>Use a valid email address you have access to</li>
                                            <li>This will be used for important notifications</li>
                                            <li>Make sure the email is spelled correctly</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-6">
                            <button type="button" onclick="closeEmailUpdateModal()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors">
                                <span id="email-update-btn-text">Update Email</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
                    </div>
                </div>
            </section>

            <!-- Uploads Section -->
            <section id="uploads" class="content-section hidden">
                <div class="space-y-2">
                    <!-- Page Header -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Document Uploads</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Upload your profile photo, certificates, and assessment work</p>
                    </div>

                    <!-- Profile & Documents Uploads -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <!-- Profile Photo Card -->
                        <div id="profile-photo-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                                        <i class="ri-user-line text-2xl text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900 dark:text-white">Profile Photo</h3>
                                        <p class="text-xs text-gray-500">JPG, PNG (Max 2MB)</p>
                                    </div>
                                </div>
                                <span class="upload-status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Not Uploaded</span>
                            </div>
                            <div class="upload-info mb-4">
                                <p class="text-xs text-gray-500">No file uploaded yet</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="uploadProfilePhoto()" class="upload-btn flex-1 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-upload-line mr-2"></i>Upload
                                </button>
                                <button onclick="viewUpload(uploadStates.profile?._id)" class="view-btn hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-eye-line"></i>
                                </button>
                                <button onclick="uploadProfilePhoto()" class="replace-btn hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-refresh-line"></i>
                                </button>
                            </div>
                        </div>

                        <!-- KCSE Results Card -->
                        <div id="kcse-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                                        <i class="ri-file-text-line text-2xl text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900 dark:text-white">KCSE Results</h3>
                                        <p class="text-xs text-gray-500">PDF, Image (Max 5MB)</p>
                                    </div>
                                </div>
                                <span class="upload-status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Not Uploaded</span>
                            </div>
                            <div class="upload-info mb-4">
                                <p class="text-xs text-gray-500">No file uploaded yet</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="uploadResults('kcse')" class="upload-btn flex-1 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-upload-line mr-2"></i>Upload
                                </button>
                                <button onclick="viewUpload(uploadStates.kcse?._id)" class="view-btn hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-eye-line"></i>
                                </button>
                                <button onclick="uploadResults('kcse')" class="replace-btn hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-refresh-line"></i>
                                </button>
                            </div>
                        </div>

                        <!-- KCPE Results Card -->
                        <div id="kcpe-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                                        <i class="ri-file-text-line text-2xl text-green-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900 dark:text-white">KCPE Results</h3>
                                        <p class="text-xs text-gray-500">PDF, Image (Max 5MB)</p>
                                    </div>
                                </div>
                                <span class="upload-status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Not Uploaded</span>
                            </div>
                            <div class="upload-info mb-4">
                                <p class="text-xs text-gray-500">No file uploaded yet</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="uploadResults('kcpe')" class="upload-btn flex-1 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-upload-line mr-2"></i>Upload
                                </button>
                                <button onclick="viewUpload(uploadStates.kcpe?._id)" class="view-btn hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-eye-line"></i>
                                </button>
                                <button onclick="uploadResults('kcpe')" class="replace-btn hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ri-refresh-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Assessments & Practicals -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="mb-6">
                            <h3 class="text-sm md:text-base font-semibold text-gray-900 dark:text-white">Unit Assessments & Practical Work</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Upload assessments and practical work for your registered units (department units only)</p>
                        </div>

                        <!-- Unit Uploads Container -->
                        <div id="unit-uploads-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Units will be loaded here dynamically -->
                            <div class="col-span-full text-center py-12">
                                <i class="ri-loader-4-line text-4xl text-gray-400 animate-spin mb-4"></i>
                                <p class="text-gray-600 dark:text-gray-400">Loading your registered units...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Instructions -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-2 md:p-3">
                        <div class="flex items-start space-x-3">
                            <i class="ri-information-line text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Upload Guidelines</h4>
                                <ul class="text-sm text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside">
                                    <li>Profile photos should be clear passport-style images (JPG/PNG, max 2MB)</li>
                                    <li>KCSE/KCPE results should be scanned copies or clear photos (PDF/Image, max 5MB)</li>
                                    <li>Assessments should be PDF documents with your work clearly visible (max 10MB)</li>
                                    <li>Practical work can be videos or photos showing your work (max 10MB)</li>
                                    <li>Only department units (not common units) allow assessment uploads</li>
                                    <li>You can replace any file - the old file will be marked as replaced</li>
                                    <li>All files are stored securely in the cloud and can be accessed by CIBEC for evaluation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notes & Messages Section -->
            <section id="notes" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Notes & Messages</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-1">Important notes from the Dean's office</p>
                            </div>
                            <button id="refresh-notes-btn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <i class="ri-refresh-line text-xl text-gray-600 dark:text-gray-400"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Tabs -->
                    <div class="px-6 pt-4">
                        <div class="flex items-center space-x-2 border-b border-gray-200 dark:border-gray-700">
                            <button class="notes-filter-tab px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary transition-colors" data-filter="all">
                                All
                            </button>
                            <button class="notes-filter-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors" data-filter="unread">
                                Unread
                                <span id="unread-count" class="ml-1 px-2 py-0.5 text-xs bg-red-500 text-white rounded-full hidden">0</span>
                            </button>
                            <button class="notes-filter-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors" data-filter="read">
                                Read
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="notes-loading" class="hidden text-center py-8">
                            <i class="ri-loader-4-line text-4xl text-primary animate-spin mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-400">Loading notes...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="notes-empty" class="hidden text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-message-3-line text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400">No notes or messages yet</p>
                            <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Notes from the Dean will appear here</p>
                        </div>
                        
                        <!-- Notes List -->
                        <div id="notes-list" class="space-y-3">
                            <!-- Notes will be loaded here dynamically -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Units Section -->
            <section id="units" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Units & Courses</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Your enrolled units and course materials</p>
                    </div>
                    <div class="p-6">
                        <div id="student-units" class="space-y-2">
                            <div class="text-center py-8">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="ri-book-open-line text-2xl text-gray-400"></i>
                                </div>
                                <p class="text-gray-600 dark:text-gray-400">No units information available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Transcript Section -->
            <section id="transcript" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Academic Transcript</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Your academic records and achievements</p>
                    </div>
                    <div class="p-6">
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-file-text-line text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400">Transcript will be available after course completion</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Graduation Application Section -->
            <section id="graduation" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Apply for Graduation</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Submit your graduation application</p>
                    </div>
                    <div class="p-6">
                        <!-- Eligibility Status -->
                        <div id="graduation-eligibility" class="mb-6">
                            <div class="flex items-center justify-center py-4">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                <span class="ml-2 text-gray-600 dark:text-gray-400">Checking eligibility...</span>
                            </div>
                        </div>

                        <!-- Graduation Application Form -->
                        <div id="graduation-form" class="hidden">
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                                <div class="flex items-start">
                                    <i class="ri-information-line text-blue-600 text-xl mr-3 mt-0.5"></i>
                                    <div>
                                        <h3 class="text-blue-800 dark:text-blue-200 font-medium mb-2">Graduation Application Requirements</h3>
                                        <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                            <li>â€¢ Level 4 students can apply in Year 1</li>
                                            <li>â€¢ Level 5 students can apply in Year 2</li>
                                            <li>â€¢ Level 6 students can apply in Year 3</li>
                                            <li>â€¢ All required units must be completed</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Information Display -->
                            <div class="grid md:grid-cols-2 gap-2 mb-3">
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-800 dark:text-white">Student Information</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Name:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-name">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Admission Number:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-admission">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Course:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-course">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Level:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-level">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Year of Study:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-year">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Intake:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-intake">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Phone Number:</span>
                                            <span class="font-medium text-gray-800 dark:text-white graduation-student-phone">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-800 dark:text-white">Application Status</h3>
                                    <div id="graduation-status-info" class="space-y-3">
                                        <!-- Status will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- Application Actions -->
                            <div class="flex justify-end space-x-4">
                                <button id="submit-graduation" class="px-3 py-1.5 text-xs md:text-sm bg-primary text-white rounded-lg hover:bg-secondary transition-colors font-medium">
                                    <i class="ri-graduation-cap-line mr-2"></i>Submit Graduation Application
                                </button>
                            </div>
                        </div>

                        <!-- Existing Application Display -->
                        <div id="graduation-existing" class="hidden">
                            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6">
                                <div class="flex items-center mb-4">
                                    <i class="ri-check-circle-line text-green-600 text-2xl mr-3"></i>
                                    <h3 class="text-green-800 dark:text-green-200 font-medium text-lg">Application Submitted</h3>
                                </div>
                                <div id="graduation-existing-details" class="space-y-2 text-sm text-green-700 dark:text-green-300">
                                    <!-- Details will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Ineligible Display -->
                        <div id="graduation-ineligible" class="hidden">
                            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6">
                                <div class="flex items-center mb-4">
                                    <i class="ri-close-circle-line text-red-600 text-2xl mr-3"></i>
                                    <h3 class="text-red-800 dark:text-red-200 font-medium text-lg">Not Eligible</h3>
                                </div>
                                <p id="graduation-ineligible-reason" class="text-red-700 dark:text-red-300"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Attachment Application Section -->
            <section id="attachment" class="content-section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-base md:text-sm md:text-base font-semibold text-gray-800 dark:text-white">Apply for Attachment</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Submit your industrial attachment application</p>
                    </div>
                    <div class="p-6">
                        <!-- Eligibility Status -->
                        <div id="attachment-eligibility" class="mb-6">
                            <div class="flex items-center justify-center py-4">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                <span class="ml-2 text-gray-600 dark:text-gray-400">Checking eligibility...</span>
                            </div>
                        </div>

                        <!-- Attachment Application Form -->
                        <div id="attachment-form" class="hidden">
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                                <div class="flex items-start">
                                    <i class="ri-information-line text-blue-600 text-xl mr-3 mt-0.5"></i>
                                    <div>
                                        <h3 class="text-blue-800 dark:text-blue-200 font-medium mb-2">Attachment Application Requirements</h3>
                                        <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                            <li>â€¢ Level 4 students can apply in Year 1</li>
                                            <li>â€¢ Level 5 students can apply in Year 2</li>
                                            <li>â€¢ Level 6 students can apply in Year 3</li>
                                            <li>â€¢ Specify your preferred county and nearest town</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Information Display -->
                            <div class="grid md:grid-cols-2 gap-2 mb-3">
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-800 dark:text-white">Student Information</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Name:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-name">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Admission Number:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-admission">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Course:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-course">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Level:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-level">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Year of Study:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-year">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Intake:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-intake">Loading...</span>
                                        </div>
                                        <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                                            <span class="text-gray-600 dark:text-gray-400">Phone Number:</span>
                                            <span class="font-medium text-gray-800 dark:text-white attachment-student-phone">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-800 dark:text-white">Attachment Location</h3>
                                    <div class="space-y-2">
                                        <div>
                                            <label for="attachment-county" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preferred County</label>
                                            <select id="attachment-county" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                                <option value="">Select County</option>
                                                <option value="Mombasa">Mombasa</option>
                                                <option value="Kwale">Kwale</option>
                                                <option value="Kilifi">Kilifi</option>
                                                <option value="Tana River">Tana River</option>
                                                <option value="Lamu">Lamu</option>
                                                <option value="Taita-Taveta">Taita-Taveta</option>
                                                <option value="Garissa">Garissa</option>
                                                <option value="Wajir">Wajir</option>
                                                <option value="Mandera">Mandera</option>
                                                <option value="Marsabit">Marsabit</option>
                                                <option value="Isiolo">Isiolo</option>
                                                <option value="Meru">Meru</option>
                                                <option value="Tharaka-Nithi">Tharaka-Nithi</option>
                                                <option value="Embu">Embu</option>
                                                <option value="Kitui">Kitui</option>
                                                <option value="Machakos">Machakos</option>
                                                <option value="Makueni">Makueni</option>
                                                <option value="Nyandarua">Nyandarua</option>
                                                <option value="Nyeri">Nyeri</option>
                                                <option value="Kirinyaga">Kirinyaga</option>
                                                <option value="Murang'a">Murang'a</option>
                                                <option value="Kiambu">Kiambu</option>
                                                <option value="Turkana">Turkana</option>
                                                <option value="West Pokot">West Pokot</option>
                                                <option value="Samburu">Samburu</option>
                                                <option value="Trans Nzoia">Trans Nzoia</option>
                                                <option value="Uasin Gishu">Uasin Gishu</option>
                                                <option value="Elgeyo-Marakwet">Elgeyo-Marakwet</option>
                                                <option value="Nandi">Nandi</option>
                                                <option value="Baringo">Baringo</option>
                                                <option value="Laikipia">Laikipia</option>
                                                <option value="Nakuru">Nakuru</option>
                                                <option value="Narok">Narok</option>
                                                <option value="Kajiado">Kajiado</option>
                                                <option value="Kericho">Kericho</option>
                                                <option value="Bomet">Bomet</option>
                                                <option value="Kakamega">Kakamega</option>
                                                <option value="Vihiga">Vihiga</option>
                                                <option value="Bungoma">Bungoma</option>
                                                <option value="Busia">Busia</option>
                                                <option value="Siaya">Siaya</option>
                                                <option value="Kisumu">Kisumu</option>
                                                <option value="Homa Bay">Homa Bay</option>
                                                <option value="Migori">Migori</option>
                                                <option value="Kisii">Kisii</option>
                                                <option value="Nyamira">Nyamira</option>
                                                <option value="Nairobi">Nairobi</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="attachment-town" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nearest Town</label>
                                            <input type="text" id="attachment-town" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter nearest town" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Application Actions -->
                            <div class="flex justify-end space-x-4">
                                <button id="submit-attachment" class="px-3 py-1.5 text-xs md:text-sm bg-primary text-white rounded-lg hover:bg-secondary transition-colors font-medium">
                                    <i class="ri-briefcase-line mr-2"></i>Submit Attachment Application
                                </button>
                            </div>
                        </div>

                        <!-- Existing Application Display -->
                        <div id="attachment-existing" class="hidden">
                            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6">
                                <div class="flex items-center mb-4">
                                    <i class="ri-check-circle-line text-green-600 text-2xl mr-3"></i>
                                    <h3 class="text-green-800 dark:text-green-200 font-medium text-lg">Application Submitted</h3>
                                </div>
                                <div id="attachment-existing-details" class="space-y-2 text-sm text-green-700 dark:text-green-300">
                                    <!-- Details will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Ineligible Display -->
                        <div id="attachment-ineligible" class="hidden">
                            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6">
                                <div class="flex items-center mb-4">
                                    <i class="ri-close-circle-line text-red-600 text-2xl mr-3"></i>
                                    <h3 class="text-red-800 dark:text-red-200 font-medium text-lg">Not Eligible</h3>
                                </div>
                                <p id="attachment-ineligible-reason" class="text-red-700 dark:text-red-300"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center gap-2">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <span class="text-gray-700 dark:text-gray-300">Loading...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="loadFallbackPDF()"></script>
    <script>
        function loadFallbackPDF() {
            // Fallback CDN if primary fails
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
            script.onerror = function() {
                console.error('All PDF CDNs failed to load');
            };
            document.head.appendChild(script);
        }
    </script>
    <script src="studentPortal.js"></script>
    <script src="uploadSection.js"></script>
    <script>
        // Initialize uploads section when uploads tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up uploads initialization');
            
            const uploadsLink = document.querySelector('a[href="#uploads"]');
            if (uploadsLink) {
                uploadsLink.addEventListener('click', function(e) {
                    console.log('Uploads link clicked');
                    // Initialize uploads section on first click
                    setTimeout(() => {
                        if (typeof initializeUploadsSection === 'function' && !window.uploadsInitialized) {
                            console.log('Initializing uploads section...');
                            window.uploadsInitialized = true;
                            initializeUploadsSection().catch(err => {
                                console.error('Error initializing uploads:', err);
                            });
                        } else if (window.uploadsInitialized) {
                            console.log('Uploads already initialized');
                        } else {
                            console.error('initializeUploadsSection function not found!');
                        }
                    }, 100);
                });
            } else {
                console.error('Uploads link not found!');
            }
        });
    </script>
    <script>
        // ========================================
        // COURSE NAME MAPPING AND UTILITY FUNCTIONS
        // ========================================
        
        // Simple function to format course names (fallback if courseToProgram is not available)
        function formatCourseName(courseCode) {
            // Try to use the global courseToProgram mapping first
            if (typeof courseToProgram !== 'undefined' && courseToProgram[courseCode]) {
                return courseToProgram[courseCode];
            }
            
            // Fallback: Convert course code to readable format
            if (!courseCode) return 'N/A';
            
            return courseCode
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .replace(/(\d+)/, ' Level $1');
        }

        // ========================================
        // GRADUATION AND ATTACHMENT APPLICATION FUNCTIONS
        // ========================================

        // Check graduation eligibility and load form
        async function checkGraduationEligibility() {
            try {
                console.log('ðŸŽ“ checkGraduationEligibility called');
                console.log('ðŸ“Š studentData:', studentData);
                
                const studentId = studentData?.admissionNumber;
                console.log('ðŸ†” Student ID:', studentId);
                
                if (!studentId) {
                    console.error('No student ID found for graduation, studentData:', studentData);
                    
                    // Try to wait for studentData to load
                    if (!studentData || !studentData.admissionNumber) {
                        console.log('â³ Waiting for student data to load...');
                        setTimeout(checkGraduationEligibility, 500);
                        return;
                    }
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}/graduation-eligibility`);
                const data = await response.json();

                const eligibilityDiv = document.getElementById('graduation-eligibility');
                const formDiv = document.getElementById('graduation-form');
                const existingDiv = document.getElementById('graduation-existing');
                const ineligibleDiv = document.getElementById('graduation-ineligible');

                // Hide loading
                eligibilityDiv.classList.add('hidden');

                if (data.hasExistingApplication) {
                    // Show existing application
                    existingDiv.classList.remove('hidden');
                    const detailsDiv = document.getElementById('graduation-existing-details');
                    const app = data.existingApplication;
                    detailsDiv.innerHTML = `
                        <p><strong>Application Date:</strong> ${new Date(app.applicationDate).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> <span class="capitalize">${app.status.replace('_', ' ')}</span></p>
                        <p><strong>Academic Year:</strong> ${app.academicYear}</p>
                        <p><strong>Semester:</strong> ${app.semester}</p>
                        ${app.comments ? `<p><strong>Comments:</strong> ${app.comments}</p>` : ''}
                    `;
                } else if (!data.canApply) {
                    // Show ineligible
                    ineligibleDiv.classList.remove('hidden');
                    document.getElementById('graduation-ineligible-reason').textContent = data.reason;
                } else {
                    // Show form
                    formDiv.classList.remove('hidden');
                    populateGraduationForm(data);
                }
            } catch (error) {
                console.error('Error checking graduation eligibility:', error);
                const eligibilityDiv = document.getElementById('graduation-eligibility');
                eligibilityDiv.innerHTML = 
                    `<div class="text-center py-4 text-red-600">
                        <i class="ri-error-warning-line text-2xl mb-2"></i>
                        <p>Error checking eligibility: ${error.message}</p>
                        <button onclick="checkGraduationEligibility()" class="mt-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            Try Again
                        </button>
                    </div>`;
            }
        }

        // Check attachment eligibility and load form
        async function checkAttachmentEligibility() {
            try {
                console.log('ðŸ” checkAttachmentEligibility called');
                console.log('ðŸ“Š studentData:', studentData);
                
                // Refresh studentData from session storage to ensure we have latest data
                const sessionData = JSON.parse(sessionStorage.getItem('studentData')) || {};
                if (sessionData && Object.keys(sessionData).length > Object.keys(studentData).length) {
                    console.log('ðŸ”„ Updating studentData from session storage');
                    studentData = sessionData;
                }
                
                const studentId = studentData?.admissionNumber;
                console.log('ðŸ†” Student ID:', studentId);
                
                if (!studentId) {
                    console.error('No student ID found, studentData:', studentData);
                    
                    // Try to wait for studentData to load
                    if (!studentData || !studentData.admissionNumber) {
                        console.log('â³ Waiting for student data to load...');
                        setTimeout(checkAttachmentEligibility, 500);
                        return;
                    }
                    return;
                }

                const url = `${API_BASE_URL}/students/${encodeURIComponent(studentId)}/attachment-eligibility`;
                console.log('ðŸŒ API_BASE_URL:', API_BASE_URL);
                console.log('ðŸŒ Fetching URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();

                const eligibilityDiv = document.getElementById('attachment-eligibility');
                const formDiv = document.getElementById('attachment-form');
                const existingDiv = document.getElementById('attachment-existing');
                const ineligibleDiv = document.getElementById('attachment-ineligible');

                // Hide loading
                eligibilityDiv.classList.add('hidden');

                if (data.hasExistingApplication) {
                    // Show existing application
                    existingDiv.classList.remove('hidden');
                    const detailsDiv = document.getElementById('attachment-existing-details');
                    const app = data.existingApplication;
                    detailsDiv.innerHTML = `
                        <p><strong>Application Date:</strong> ${new Date(app.applicationDate).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> <span class="capitalize">${app.status.replace('_', ' ')}</span></p>
                        <p><strong>Location:</strong> ${app.county}, ${app.nearestTown}</p>
                        <p><strong>Academic Year:</strong> ${app.academicYear}</p>
                        <p><strong>Semester:</strong> ${app.semester}</p>
                        ${app.comments ? `<p><strong>Comments:</strong> ${app.comments}</p>` : ''}
                    `;
                } else if (!data.canApply) {
                    // Show ineligible
                    ineligibleDiv.classList.remove('hidden');
                    document.getElementById('attachment-ineligible-reason').textContent = data.reason;
                } else {
                    // Show form
                    formDiv.classList.remove('hidden');
                    populateAttachmentForm(data);
                }
            } catch (error) {
                console.error('Error checking attachment eligibility:', error);
                const eligibilityDiv = document.getElementById('attachment-eligibility');
                eligibilityDiv.innerHTML = 
                    `<div class="text-center py-4 text-red-600">
                        <i class="ri-error-warning-line text-2xl mb-2"></i>
                        <p>Error checking eligibility: ${error.message}</p>
                        <button onclick="checkAttachmentEligibility()" class="mt-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            Try Again
                        </button>
                    </div>`;
            }
        }

        // Populate graduation form with student data
        function populateGraduationForm(data) {
            console.log('ðŸŽ“ Populating graduation form with data:', data);
            console.log('ðŸ‘¤ Student data:', studentData);
            
            // Basic student info
            document.querySelector('.graduation-student-name').textContent = studentData.name || 'N/A';
            document.querySelector('.graduation-student-admission').textContent = studentData.admissionNumber || 'N/A';
            document.querySelector('.graduation-student-course').textContent = formatCourseName(studentData.course);
            document.querySelector('.graduation-student-level').textContent = `Level ${data.level}`;
            document.querySelector('.graduation-student-year').textContent = `Year ${data.yearOfStudy}`;
            
            // Additional fields - intake formatting (same logic as profile section)
            console.log('ðŸŽ“ Intake data for graduation:', { 
                intake: studentData.intake, 
                intakeYear: studentData.intakeYear 
            });
            
            let intakeText = 'N/A';
            if (studentData.intake && studentData.intakeYear) {
                const formattedIntake = studentData.intake.charAt(0).toUpperCase() + studentData.intake.slice(1);
                intakeText = `${formattedIntake} ${studentData.intakeYear}`;
            } else if (studentData.intake || studentData.intakeYear) {
                // Fallback if only one field is available
                const intake = studentData.intake || 'Unknown';
                const year = studentData.intakeYear || new Date().getFullYear();
                const formattedIntake = intake.charAt(0).toUpperCase() + intake.slice(1);
                intakeText = `${formattedIntake} ${year}`;
            } else {
                // Final fallback - extract from admission number if possible (same logic as profile)
                const admissionNumber = studentData.admissionNumber || '';
                const intakeMatch = admissionNumber.match(/\/([JS]\d{2})$/);
                if (intakeMatch) {
                    const intakeCode = intakeMatch[1];
                    const intakePrefix = intakeCode.charAt(0);
                    const yearSuffix = intakeCode.slice(1);
                    const fullYear = '20' + yearSuffix;
                    const intakeName = intakePrefix === 'J' ? 'January' : 'September';
                    intakeText = `${intakeName} ${fullYear}`;
                    console.log('âœ… Extracted intake from admission number for graduation:', intakeText);
                } else {
                    console.warn('âš ï¸ No intake data found in studentData for graduation');
                }
            }
            
            document.querySelector('.graduation-student-intake').textContent = intakeText;
            document.querySelector('.graduation-student-phone').textContent = studentData.phoneNumber || 'N/A';

            const statusInfo = document.getElementById('graduation-status-info');
            statusInfo.innerHTML = `
                <div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <p class="text-sm text-green-700 dark:text-green-300">âœ“ Eligible to apply for graduation</p>
                    <p class="text-xs text-green-600 dark:text-green-400 mt-1">Level ${data.level} students can apply in Year ${data.yearOfStudy}</p>
                </div>
            `;
        }

        // Populate attachment form with student data
        function populateAttachmentForm(data) {
            console.log('ðŸ“ Populating attachment form with data:', data);
            console.log('ðŸ‘¤ Student data:', studentData);
            console.log('ðŸ” Student data keys:', Object.keys(studentData));
            console.log('ðŸ—“ï¸ Intake fields specifically:', {
                intake: studentData.intake,
                intakeYear: studentData.intakeYear,
                hasIntake: 'intake' in studentData,
                hasIntakeYear: 'intakeYear' in studentData
            });
            
            // Basic student info
            document.querySelector('.attachment-student-name').textContent = studentData.name || 'N/A';
            document.querySelector('.attachment-student-admission').textContent = studentData.admissionNumber || 'N/A';
            document.querySelector('.attachment-student-course').textContent = formatCourseName(studentData.course);
            document.querySelector('.attachment-student-level').textContent = `Level ${data.level}`;
            document.querySelector('.attachment-student-year').textContent = `Year ${data.yearOfStudy}`;
            
            // Additional fields - intake formatting (same logic as profile section)
            console.log('ðŸ—“ï¸ Intake data for attachment:', { 
                intake: studentData.intake, 
                intakeYear: studentData.intakeYear,
                fullStudentData: studentData 
            });
            
            let intakeText = 'N/A';
            if (studentData.intake && studentData.intakeYear) {
                const formattedIntake = studentData.intake.charAt(0).toUpperCase() + studentData.intake.slice(1);
                intakeText = `${formattedIntake} ${studentData.intakeYear}`;
            } else if (studentData.intake || studentData.intakeYear) {
                // Fallback if only one field is available
                const intake = studentData.intake || 'Unknown';
                const year = studentData.intakeYear || new Date().getFullYear();
                const formattedIntake = intake.charAt(0).toUpperCase() + intake.slice(1);
                intakeText = `${formattedIntake} ${year}`;
            } else {
                // Final fallback - extract from admission number if possible (same logic as profile)
                const admissionNumber = studentData.admissionNumber || '';
                const intakeMatch = admissionNumber.match(/\/([JS]\d{2})$/);
                if (intakeMatch) {
                    const intakeCode = intakeMatch[1];
                    const intakePrefix = intakeCode.charAt(0);
                    const yearSuffix = intakeCode.slice(1);
                    const fullYear = '20' + yearSuffix;
                    const intakeName = intakePrefix === 'J' ? 'January' : 'September';
                    intakeText = `${intakeName} ${fullYear}`;
                    console.log('âœ… Extracted intake from admission number for attachment:', intakeText);
                } else {
                    console.warn('âš ï¸ No intake data found in studentData for attachment');
                }
            }
            
            document.querySelector('.attachment-student-intake').textContent = intakeText;
            document.querySelector('.attachment-student-phone').textContent = studentData.phoneNumber || 'N/A';
        }

        // Submit graduation application
        async function submitGraduationApplication() {
            try {
                showLoading('Submitting graduation application...');
                
                const studentId = studentData.admissionNumber;
                const response = await fetch(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}/graduation-application`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to submit application');
                }

                showToast('Graduation application submitted successfully!', 'success');
                
                // Refresh the page to show updated status
                setTimeout(() => {
                    checkGraduationEligibility();
                }, 1000);

            } catch (error) {
                console.error('Error submitting graduation application:', error);
                showToast(error.message || 'Failed to submit application', 'error');
            } finally {
                hideLoading();
            }
        }

        // Submit attachment application
        async function submitAttachmentApplication() {
            try {
                const county = document.getElementById('attachment-county').value;
                const town = document.getElementById('attachment-town').value;

                if (!county || !town) {
                    showToast('Please select county and enter nearest town', 'error');
                    return;
                }

                showLoading('Submitting attachment application...');
                
                const studentId = studentData.admissionNumber;
                const response = await fetch(`${API_BASE_URL}/students/${encodeURIComponent(studentId)}/attachment-application`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        county: county,
                        nearestTown: town
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to submit application');
                }

                showToast('Attachment application submitted successfully!', 'success');
                
                // Refresh the page to show updated status
                setTimeout(() => {
                    checkAttachmentEligibility();
                }, 1000);

            } catch (error) {
                console.error('Error submitting attachment application:', error);
                showToast(error.message || 'Failed to submit application', 'error');
            } finally {
                hideLoading();
            }
        }

        // Navigation is now handled in the setupUI function

        // Initialize the portal when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePortal();
            setupUI();
            setupReceiptModalListeners();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Add event listeners for application buttons
            const graduationBtn = document.getElementById('submit-graduation');
            const attachmentBtn = document.getElementById('submit-attachment');

            if (graduationBtn) {
                graduationBtn.addEventListener('click', submitGraduationApplication);
            }

            if (attachmentBtn) {
                attachmentBtn.addEventListener('click', submitAttachmentApplication);
            }
        });

        // Make functions globally available for debugging
        window.checkAttachmentEligibility = checkAttachmentEligibility;
        window.checkGraduationEligibility = checkGraduationEligibility;

        // Setup UI interactions
        function setupUI() {
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            mobileMenuBtn?.addEventListener('click', () => {
                sidebar.classList.add('mobile-open');
                mobileOverlay.classList.remove('hidden');
            });

            sidebarToggle?.addEventListener('click', () => {
                sidebar.classList.remove('mobile-open');
                mobileOverlay.classList.add('hidden');
            });

            mobileOverlay?.addEventListener('click', () => {
                sidebar.classList.remove('mobile-open');
                mobileOverlay.classList.add('hidden');
            });

            // Desktop sidebar toggle
            const desktopSidebarToggle = document.getElementById('desktop-sidebar-toggle');
            const mainContent = document.getElementById('main-content');
            let sidebarCollapsed = false;

            desktopSidebarToggle?.addEventListener('click', () => {
                sidebarCollapsed = !sidebarCollapsed;
                if (sidebarCollapsed) {
                    sidebar.classList.add('sidebar-collapsed');
                    mainContent.classList.remove('md:ml-64');
                    mainContent.classList.add('md:ml-16');
                    desktopSidebarToggle.innerHTML = '<i class="ri-menu-unfold-line text-xl text-gray-600 dark:text-gray-300"></i>';
                } else {
                    sidebar.classList.remove('sidebar-collapsed');
                    mainContent.classList.remove('md:ml-16');
                    mainContent.classList.add('md:ml-64');
                    desktopSidebarToggle.innerHTML = '<i class="ri-menu-fold-line text-xl text-gray-600 dark:text-gray-300"></i>';
                }
            });

            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('page-title');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    
                    // Update active nav link
                    navLinks.forEach(nl => nl.classList.remove('active', 'bg-primary', 'text-white'));
                    link.classList.add('active', 'bg-primary', 'text-white');
                    
                    // Show target section
                    contentSections.forEach(section => section.classList.add('hidden'));
                    document.getElementById(targetId)?.classList.remove('hidden');
                    
                    // Update page title
                    const titles = {
                        'dashboard': 'Dashboard',
                        'profile': 'Profile',
                        'financial': 'Financial Information',
                        'payments': 'Payment History',
                        'units': 'Units & Courses',
                        'transcript': 'Transcript',
                        'graduation': 'Apply for Graduation',
                        'attachment': 'Apply for Attachment'
                    };
                    pageTitle.textContent = titles[targetId] || 'Dashboard';

                    // Trigger eligibility checks for application sections
                    console.log('ðŸ§­ Navigation clicked for section:', targetId);
                    if (targetId === 'graduation') {
                        console.log('ðŸ“ Triggering graduation eligibility check');
                        setTimeout(checkGraduationEligibility, 100);
                    } else if (targetId === 'attachment') {
                        console.log('ðŸ“ Triggering attachment eligibility check');
                        setTimeout(checkAttachmentEligibility, 100);
                    }

                    // Close mobile menu
                    sidebar.classList.remove('mobile-open');
                    mobileOverlay.classList.add('hidden');
                });
            });

            // Dark mode toggle
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            darkModeToggle?.addEventListener('click', toggleDarkMode);

            // Logout modal function
            function showLogoutModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-sm transform transition-all duration-300">
                        <div class="p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-2 bg-red-100 dark:bg-red-900 rounded-lg">
                                    <i class="ri-logout-box-line text-red-600 dark:text-red-400 text-xl"></i>
                                </div>
                                <h3 class="text-sm md:text-base font-semibold text-gray-800 dark:text-white">Confirm Logout</h3>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to logout? You will need to login again to access your account.</p>
                            <div class="flex gap-3">
                                <button onclick="cancelLogout()" class="flex-1 px-4 py-2 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    Cancel
                                </button>
                                <button onclick="confirmLogout()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add global functions for modal actions
                window.cancelLogout = function() {
                    document.body.removeChild(modal);
                    delete window.cancelLogout;
                    delete window.confirmLogout;
                };
                
                window.confirmLogout = function() {
                    document.body.removeChild(modal);
                    delete window.cancelLogout;
                    delete window.confirmLogout;
                    
                    // Clear session data
                    sessionStorage.clear();
                    localStorage.removeItem('studentData');
                    
                    // Redirect to login page
                    window.location.replace('/student/login');
                };
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                showLogoutModal();
            });
        }

        // Receipt modal event listeners
        function setupReceiptModalListeners() {
            const closeReceiptModalBtn = document.getElementById('close-receipt-modal');
            const exportReceiptBtn = document.getElementById('export-receipt');
            const printReceiptBtn = document.getElementById('print-receipt');

            closeReceiptModalBtn?.addEventListener('click', closeReceiptModal);
            exportReceiptBtn?.addEventListener('click', exportReceipt);
            printReceiptBtn?.addEventListener('click', printReceipt);
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const currentTimeElement = document.getElementById('current-time');
            if (currentTimeElement) {
                currentTimeElement.textContent = timeString;
            }
        }

        // Dark mode functionality
        function toggleDarkMode() {
            const html = document.documentElement;
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const icon = darkModeToggle?.querySelector('i');
            
            html.classList.toggle('dark');
            
            if (html.classList.contains('dark')) {
                localStorage.setItem('dark-mode', 'enabled');
                if (icon) {
                    icon.classList.remove('ri-moon-line');
                    icon.classList.add('ri-sun-line');
                }
            } else {
                localStorage.setItem('dark-mode', 'disabled');
                if (icon) {
                    icon.classList.remove('ri-sun-line');
                    icon.classList.add('ri-moon-line');
                }
            }
        }

        // Initialize dark mode
        if (localStorage.getItem('dark-mode') === 'enabled') {
            document.documentElement.classList.add('dark');
            const icon = document.querySelector('#dark-mode-toggle i');
            if (icon) {
                icon.classList.remove('ri-moon-line');
                icon.classList.add('ri-sun-line');
            }
        }

        // ========================================
        // EMAIL UPDATE FUNCTIONALITY
        // ========================================

        // Open email update modal
        function openEmailUpdateModal() {
            const modal = document.getElementById('email-update-modal');
            const emailInput = document.getElementById('new-email');
            
            // Pre-fill current email if available
            const currentEmail = document.querySelector('.student-email').textContent;
            if (currentEmail && currentEmail !== 'Not set') {
                emailInput.value = currentEmail;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            emailInput.focus();
        }

        // Close email update modal
        function closeEmailUpdateModal() {
            const modal = document.getElementById('email-update-modal');
            const form = document.getElementById('email-update-form');
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            form.reset();
        }

        // Handle email update form submission
        document.getElementById('email-update-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const emailInput = document.getElementById('new-email');
            const submitBtn = document.querySelector('#email-update-btn-text');
            const newEmail = emailInput.value.trim();
            
            if (!newEmail) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                // Update button state
                submitBtn.textContent = 'Updating...';
                
                const studentData = JSON.parse(sessionStorage.getItem('studentData'));
                const response = await fetch(`${API_BASE_URL}/students/${encodeURIComponent(studentData.admissionNumber)}/email`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: newEmail })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update the display
                    document.querySelector('.student-email').textContent = newEmail;
                    
                    // Update session storage
                    studentData.email = newEmail;
                    sessionStorage.setItem('studentData', JSON.stringify(studentData));
                    
                    showToast('Email updated successfully!', 'success');
                    closeEmailUpdateModal();
                } else {
                    showToast(data.message || 'Failed to update email', 'error');
                }
            } catch (error) {
                console.error('Error updating email:', error);
                showToast('Error updating email. Please try again.', 'error');
            } finally {
                // Reset button state
                submitBtn.textContent = 'Update Email';
            }
        });

        // Make functions globally available
        window.openEmailUpdateModal = openEmailUpdateModal;
        window.closeEmailUpdateModal = closeEmailUpdateModal;
    </script>
</body>
</html>